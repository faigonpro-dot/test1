<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Les parts en %</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #000;
      background-color: #fff;
      line-height: 1.6;
    }

    /* --- En-tête --- */
    header {
      position: relative;
      height: 400px;
      background-image: url('assets/images/Bannière%20index.jpg');
      background-size: cover;
      background-position: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
    }

    .logo-container {
      width: 320px;
      height: 320px;
      border-radius: 50%;
      background: linear-gradient(135deg, #FFA500, #FFD700, #8B4513);
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
    }

    .logo-container img {
      width: 90%;
      height: 90%;
      object-fit: contain;
      background-color: transparent;
    }

    .logo-text {
      text-align: center;
      margin-top: 16px;
      font-weight: bold;
      font-size: 1.6em;
      color: #FFA500;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    /* --- Menu --- */
    nav {
      background-color: white;
      padding: 12px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    nav ul {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      list-style: none;
      gap: 20px;
    }

    nav a {
      text-decoration: none;
      color: black;
      font-weight: 600;
      padding: 8px 12px;
      border-radius: 4px;
      transition: background 0.3s;
    }

    nav a:hover,
    nav a.active {
      background-color: #FFA500;
      color: white;
    }

    /* --- Contenu principal --- */
    main {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
      text-align: center;
    }

    main h1 {
      color: #FFA500;
      margin-bottom: 20px;
      font-size: 2.4em;
    }

    .infographie {
      margin: 20px auto 40px;
      max-width: 100%;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .infographie img {
      width: 100%;
      height: auto;
      display: block;
    }

    /* --- Styles pour les exercices --- */
    .partNombre { color: #28a745; font-weight: bold; }     /* Vert */
    .total { color: #007bff; font-weight: bold; }          /* Bleu */
    .partPct { color: #28a745; font-weight: bold; }        /* Vert (même que partNombre) */
    .correct-message { color: green; font-weight: bold; }
    .incorrect-message { color: red; font-weight: bold; }

    .exercise-section {
      max-width: 800px;
      margin: 0 auto 40px;
      text-align: left;
    }

    .formula {
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 8px;
    }

    .formula.partNombre { background-color: #d4edda; border-left: 4px solid #28a745; }
    .formula.total { background-color: #dbeafe; border-left: 4px solid #007bff; }
    .formula.partPct { background-color: #d4edda; border-left: 4px solid #28a745; }

    .exercise-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .exercise-card h2 {
      font-size: 1.4em;
      margin-bottom: 15px;
      color: #2c3e50;
    }

    #exercise-container {
      background-color: #f3e5f5;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    #student-answer {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
      margin-bottom: 10px;
    }

    #check-answer, #new-exercise {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }

    #check-answer:hover { background-color: #2980b9; }
    #new-exercise:hover { background-color: #27ae60; }

    #result-container {
      display: none;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }

    #result-container.correct-answer { background-color: #d4edda; border: 1px solid #c3e6cb; }
    #result-container.incorrect-answer { background-color: #f8d7da; border: 1px solid #f5c6cb; }

    .progress-section {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .progress-section h2 {
      font-size: 1.4em;
      margin-bottom: 15px;
      color: #2c3e50;
    }

    .progress-bar-container {
      height: 20px;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }

    #progress-bar {
      height: 100%;
      background: linear-gradient(to right, #3498db, #2c3e50);
      width: 0%;
    }

    /* --- Tableau --- */
    .table-container {
      margin: 20px 0;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95em;
    }

    th, td {
      padding: 8px;
      text-align: center;
      border: 1px solid #ddd;
    }

    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    input.table-input {
      width: 100%;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: center;
    }

    .total-row {
      font-weight: bold;
      background-color: #e9ecef;
    }

    /* --- Mobile --- */
    @media (max-width: 768px) {
      header {
        height: 300px;
      }
      .logo-container {
        width: 240px;
        height: 240px;
      }
      .logo-container img {
        width: 85%;
        height: 85%;
      }
      .logo-text {
        font-size: 1.3em;
      }
      main h1 {
        font-size: 2em;
      }
      .exercise-section,
      .progress-section {
        padding: 0 10px;
      }
      .table-container {
        font-size: 0.85em;
      }
    }
  </style>
</head>
<body>

  <!-- En-tête -->
  <header>
    <div class="logo-container">
      <img src="assets/images/logo.png" alt="Le prof de Vente">
    </div>
    <div class="logo-text">Le prof de Vente</div>
  </header>

  <!-- Menu -->
  <nav>
    <ul>
      <li><a href="index.html">Accueil</a></li>
      <li><a href="mcv.html">Le Bac Pro MCV</a></li>
      <li><a href="referentiel.html">Les 3 pôles</a></li>
      <li><a href="optionab.html">Option A & B</a></li>
      <li><a href="calculs.html">Calculs commerciaux</a></li>
      <li><a href="epreuves.html">Les Épreuves</a></li>
      <li><a href="actu.html">Actualités commerciales</a></li>
      <li><a href="contact.html">Contact</a></li>
    </ul>
  </nav>

  <!-- Contenu -->
  <main>
    <h1>Les parts en %</h1>

    <!-- Infographie -->
    <div class="infographie">
      <img src="assets/images/partpourcentage.png" alt="Infographie : Les parts en %">
    </div>

    <!-- Formules -->
    <div class="exercise-section">
      <div class="exercise-card">
        <h2>Formule à connaître</h2>
        <div class="formula partPct">
          <p><span class="partPct">Part en %</span> = (<span class="partNombre">Part en nombre</span> ÷ <span class="total">Total</span>) × 100</p>
        </div>
      </div>

      <!-- Exercice interactif -->
      <div class="exercise-card">
        <h2>Exercice interactif</h2>
        <select id="difficulty" class="px-3 py-2 border rounded mb-3">
          <option value="easy">Facile (un seul calcul)</option>
          <option value="medium">Moyen (tableau - nombres entiers)</option>
          <option value="hard">Difficile (tableau - nombres décimaux)</option>
        </select>
        <div id="exercise-container">
          <p id="exercise-text" class="mb-2"></p>
          <input type="text" id="student-answer" placeholder="Votre réponse (ex: 20%)" pattern="[0-9.,]+%?" title="Entrez un nombre suivi du symbole %" step="0.01">
          <button id="check-answer">Vérifier</button>
          <p id="input-hint" class="text-xs text-gray-500 mt-1 italic"></p>
        </div>
        <div id="result-container">
          <p id="result-text"></p>
          <div id="correction-details" class="mt-2"></div>
        </div>
        <button id="new-exercise">Nouvel exercice</button>
      </div>

      <!-- Progression -->
      <div class="progress-section">
        <h2>Votre progression</h2>
        <div class="progress-bar-container">
          <div id="progress-bar"></div>
        </div>
        <div class="flex justify-between text-sm">
          <p>Exercices réussis: <span id="correct-count">0</span></p>
          <p>Exercices tentés: <span id="total-count">0</span></p>
        </div>
      </div>
    </div>
  </main>

  <!-- Script JS -->
  <script>
    let correctAnswers = 0;
    let totalAttempts = 0;

    let currentExercise = {
        type: null,
        partNombre: 0,
        total: 0,
        answer: 0,
        useDecimals: false,
        products: [],
        totalCalculated: 0
    };

    function formatNumber(number, useDecimals) {
        return useDecimals ? number.toFixed(2) : Math.round(number);
    }

    function getRandomNumber(min, max, useDecimals = false) {
        const num = Math.random() * (max - min) + min;
        return useDecimals ? Number(num.toFixed(2)) : Math.round(num);
    }

    function updateInputHint(useDecimals) {
        const inputHint = document.getElementById('input-hint');
        if (useDecimals) {
            inputHint.textContent = "Entrez votre réponse avec 2 chiffres après la virgule et le symbole % (ex: 45.75%)";
            document.getElementById('student-answer').setAttribute('pattern', '[0-9.,]+%?');
        } else {
            inputHint.textContent = "Entrez votre réponse avec le symbole % (ex: 20%)";
            document.getElementById('student-answer').setAttribute('pattern', '[0-9]+%?');
        }
    }

    function generateExercise() {
        const difficulty = document.getElementById('difficulty').value;
        let exerciseText = '';
        let answer = 0;
        let useDecimals = difficulty !== 'easy';

        // Génération réaliste
        switch(difficulty) {
            case 'easy':
                const partNombre = getRandomNumber(1, 100, false);
                const total = getRandomNumber(partNombre, 200, false);
                answer = (partNombre / total) * 100;
                exerciseText = `Un produit a une part en nombre de ${partNombre} sur un total de ${total}. Calculez la part en %.`;
                currentExercise = {
                    type: 'easy',
                    partNombre,
                    total,
                    answer: Number(answer.toFixed(2)),
                    useDecimals: true
                };
                break;

            case 'medium':
                // Génération d'un tableau avec 3 produits
                const products = [];
                let total = 0;
                for (let i = 0; i < 3; i++) {
                    const quantity = getRandomNumber(10, 100, false);
                    products.push({
                        name: `Produit ${i+1}`,
                        quantity,
                        pct: 0
                    });
                    total += quantity;
                }
                // Calcul des parts en %
                products.forEach(p => {
                    p.pct = (p.quantity / total) * 100;
                });

                exerciseText = `Complétez le tableau ci-dessous. Le total des quantités est à calculer par vous.`;
                currentExercise = {
                    type: 'medium',
                    products,
                    total,
                    useDecimals: false
                };
                break;

            case 'hard':
                // Génération d'un tableau avec 3 produits (décimaux)
                const productsHard = [];
                let totalHard = 0;
                for (let i = 0; i < 3; i++) {
                    const quantity = getRandomNumber(10, 100, true);
                    productsHard.push({
                        name: `Produit ${i+1}`,
                        quantity,
                        pct: 0
                    });
                    totalHard += quantity;
                }
                // Calcul des parts en %
                productsHard.forEach(p => {
                    p.pct = (p.quantity / totalHard) * 100;
                });

                exerciseText = `Complétez le tableau ci-dessous. Le total des quantités est à calculer par vous.`;
                currentExercise = {
                    type: 'hard',
                    products: productsHard,
                    total: totalHard,
                    useDecimals: true
                };
                break;
        }

        // ✅ Injection sécurisée de l'énoncé
        const exerciseTextEl = document.getElementById('exercise-text');
        if (exerciseTextEl) {
            exerciseTextEl.textContent = exerciseText;
        }

        document.getElementById('student-answer').value = '';
        document.getElementById('result-container').style.display = 'none';
        updateInputHint(useDecimals);

        // Si c'est un tableau, on génère le HTML du tableau
        if (currentExercise.type === 'medium' || currentExercise.type === 'hard') {
            generateTable();
        }
    }

    function generateTable() {
        const container = document.getElementById('exercise-container');
        let tableHTML = `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Désignation</th>
                  <th>Quantité vendue</th>
                  <th>Part en %</th>
                </tr>
              </thead>
              <tbody>
        `;

        currentExercise.products.forEach((product, index) => {
            tableHTML += `
              <tr>
                <td>${product.name}</td>
                <td>${formatNumber(product.quantity, currentExercise.useDecimals)}</td>
                <td><input type="text" class="table-input" data-index="${index}" placeholder="%"></td>
              </tr>
            `;
        });

        tableHTML += `
              <tr class="total-row">
                <td>Total</td>
                <td id="total-quantity">${formatNumber(currentExercise.total, currentExercise.useDecimals)}</td>
                <td id="total-pct">0.00%</td>
              </tr>
            </tbody>
            </table>
          </div>
        `;

        // ✅ Remplace le contenu de l'exercice par le tableau
        container.innerHTML = `
          <p id="exercise-text" class="mb-2">${document.getElementById('exercise-text').textContent}</p>
          ${tableHTML}
          <button id="check-answer">Vérifier</button>
          <p id="input-hint" class="text-xs text-gray-500 mt-1 italic"></p>
        `;

        // ✅ Ajoute les event listeners aux inputs du tableau
        const inputs = document.querySelectorAll('.table-input');
        inputs.forEach(input => {
            input.addEventListener('input', updateTotalPct);
        });
    }

    function updateTotalPct() {
        let sumPct = 0;
        const inputs = document.querySelectorAll('.table-input');
        inputs.forEach(input => {
            const value = input.value.trim();
            if (value && value.endsWith('%')) {
                const num = parseFloat(value.replace('%', '').replace(',', '.'));
                if (!isNaN(num)) {
                    sumPct += num;
                }
            }
        });
        document.getElementById('total-pct').textContent = `${sumPct.toFixed(2)}%`;
    }

    function checkAnswer() {
        const studentAnswerInput = document.getElementById('student-answer').value.trim();
        const resultContainer = document.getElementById('result-container');
        const resultText = document.getElementById('result-text');
        const correctionDetails = document.getElementById('correction-details');

        if (studentAnswerInput === '') {
            alert("Veuillez entrer une réponse.");
            return;
        }

        totalAttempts++;

        resultContainer.style.display = 'block';

        let isCorrect = false;
        let correctionText = '';

        if (currentExercise.type === 'easy') {
            // Vérifie si le résultat est correct (avec ou sans %)
            const studentAnswer = parseFloat(studentAnswerInput.replace('%', '').replace(',', '.'));
            const tolerance = currentExercise.useDecimals ? 0.01 : 0.5;

            if (Math.abs(studentAnswer - currentExercise.answer) < tolerance) {
                isCorrect = true;
                correctionText = `<p>Bravo ! Votre réponse est correcte.</p>`;
            } else {
                // Vérifie si le symbole % est manquant
                if (!
